<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>dotdock — Compare</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', system-ui, -apple-system, Segoe UI, sans-serif; }
    .brand-title { font-family: 'Playfair Display', serif; letter-spacing: 0.03em; }
  </style>
</head>

<body class="bg-gray-50">
  <header class="bg-white border-b border-gray-200 shadow-sm sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center gap-4">
      <a href="index.html" class="text-sm font-semibold text-amber-700 hover:underline">← Back to dotdock</a>
      <div class="ml-auto flex flex-wrap gap-2">
        <button id="swapBtn" class="px-3 py-2 text-sm border border-gray-300 rounded bg-white hover:bg-gray-50">Swap</button>
        <button id="copyBtn" class="px-3 py-2 text-sm bg-amber-600 text-white rounded hover:bg-amber-700">Copy compare link</button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6">
    <div id="errorBox" class="hidden bg-red-50 border border-red-200 text-red-800 rounded-lg p-4 mb-6">
      <div class="font-semibold">Error</div>
      <div id="errorText" class="mt-1 text-sm"></div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Left -->
      <section class="bg-white border border-gray-200 rounded-lg overflow-hidden shadow-sm">
        <div class="px-4 py-3 border-b border-gray-200 flex items-center justify-between gap-3">
          <div class="min-w-0">
            <div class="text-xs text-gray-500">Left</div>
            <div id="tLeft" class="font-semibold text-gray-900 truncate">Loading…</div>
          </div>
          <div class="flex flex-wrap gap-2">
            <a id="leftReport" class="px-3 py-1.5 text-xs border border-gray-300 rounded bg-white hover:bg-gray-50" href="#">Report</a>
            <a id="leftView" target="_blank" rel="noopener" class="px-3 py-1.5 text-xs border border-gray-300 rounded bg-white hover:bg-gray-50" href="#">View</a>
            <button id="leftNb" class="px-3 py-1.5 text-xs border border-gray-300 rounded bg-white hover:bg-gray-50">NotebookLM</button>
          </div>
        </div>
        <iframe id="frameLeft" class="w-full" style="height:70vh;" title="Left PDF" loading="lazy"></iframe>
      </section>

      <!-- Right -->
      <section class="bg-white border border-gray-200 rounded-lg overflow-hidden shadow-sm">
        <div class="px-4 py-3 border-b border-gray-200 flex items-center justify-between gap-3">
          <div class="min-w-0">
            <div class="text-xs text-gray-500">Right</div>
            <div id="tRight" class="font-semibold text-gray-900 truncate">Loading…</div>
          </div>
          <div class="flex flex-wrap gap-2">
            <a id="rightReport" class="px-3 py-1.5 text-xs border border-gray-300 rounded bg-white hover:bg-gray-50" href="#">Report</a>
            <a id="rightView" target="_blank" rel="noopener" class="px-3 py-1.5 text-xs border border-gray-300 rounded bg-white hover:bg-gray-50" href="#">View</a>
            <button id="rightNb" class="px-3 py-1.5 text-xs border border-gray-300 rounded bg-white hover:bg-gray-50">NotebookLM</button>
          </div>
        </div>
        <iframe id="frameRight" class="w-full" style="height:70vh;" title="Right PDF" loading="lazy"></iframe>
      </section>
    </div>

    <!-- Notes -->
    <section class="mt-6 bg-white border border-gray-200 rounded-lg p-4">
      <div class="flex items-center justify-between gap-3">
        <div>
          <div class="text-sm font-semibold text-gray-900">Comparison notes</div>
          <div class="text-xs text-gray-500">Saved locally for this pair of reports.</div>
        </div>
        <button id="clearNotesBtn" class="text-xs font-semibold text-gray-500 hover:underline">Clear notes</button>
      </div>

      <textarea id="notes" class="mt-3 w-full border rounded px-3 py-2 text-sm" rows="6"
                placeholder="Write differences, key takeaways, etc."></textarea>

      <div id="savedLine" class="mt-2 text-xs text-gray-500"></div>
    </section>
  </main>

  <div id="toast"
       class="hidden fixed bottom-4 left-1/2 -translate-x-1/2 z-50 bg-gray-900 text-white text-sm px-4 py-2 rounded shadow-lg">
    Copied
  </div>

<script>
  function qs(name){ return new URLSearchParams(location.search).get(name) || ""; }
  function drivePreviewUrl(fileId){ return `https://drive.google.com/file/d/${encodeURIComponent(fileId)}/preview`; }
  function reportUrl(fileId, titleHint){
    const base = `report.html?id=${encodeURIComponent(fileId)}`;
    return titleHint ? `${base}&t=${encodeURIComponent(titleHint)}` : base;
  }
  function viewerUrl(fileId, titleHint){
    const base = `view.html?id=${encodeURIComponent(fileId)}`;
    return titleHint ? `${base}&t=${encodeURIComponent(titleHint)}` : base;
  }
  function driveShareUrl(fileId){
    return `https://drive.google.com/file/d/${encodeURIComponent(fileId)}/view?usp=sharing`;
  }

  function showToast(msg){
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.classList.remove("hidden");
    clearTimeout(showToast._t);
    showToast._t = setTimeout(() => t.classList.add("hidden"), 1400);
  }

  function pairKey(a, b){
    const x = String(a), y = String(b);
    const s = [x, y].sort();
    return `dotdock_compare_notes_v1:${s[0]}::${s[1]}`;
  }

  const leftId = qs("left");
  const rightId = qs("right");
  const t1 = qs("t1");
  const t2 = qs("t2");

  const errorBox = document.getElementById("errorBox");
  const errorText = document.getElementById("errorText");

  function setError(msg){
    errorBox.classList.remove("hidden");
    errorText.textContent = msg;
  }

  if (!leftId || !rightId) {
    setError("Missing left/right ids in URL. Go back to the catalog and select two reports to compare.");
  } else {
    document.getElementById("tLeft").textContent = t1 || "Report";
    document.getElementById("tRight").textContent = t2 || "Report";
    document.title = `dotdock — Compare`;

    document.getElementById("frameLeft").src = drivePreviewUrl(leftId);
    document.getElementById("frameRight").src = drivePreviewUrl(rightId);

    document.getElementById("leftReport").href = reportUrl(leftId, t1);
    document.getElementById("rightReport").href = reportUrl(rightId, t2);

    document.getElementById("leftView").href = viewerUrl(leftId, t1);
    document.getElementById("rightView").href = viewerUrl(rightId, t2);

    document.getElementById("leftNb").addEventListener("click", async () => {
      const url = driveShareUrl(leftId);
      try { await navigator.clipboard.writeText(url); showToast("Left link copied for NotebookLM"); } catch { showToast("Copy failed"); }
      window.open("https://notebooklm.google.com/", "_blank", "noopener");
    });
    document.getElementById("rightNb").addEventListener("click", async () => {
      const url = driveShareUrl(rightId);
      try { await navigator.clipboard.writeText(url); showToast("Right link copied for NotebookLM"); } catch { showToast("Copy failed"); }
      window.open("https://notebooklm.google.com/", "_blank", "noopener");
    });

    // Notes
    const key = pairKey(leftId, rightId);
    const notesEl = document.getElementById("notes");
    const savedLine = document.getElementById("savedLine");
    const clearNotesBtn = document.getElementById("clearNotesBtn");

    function loadNotes(){
      try { notesEl.value = localStorage.getItem(key) || ""; } catch {}
    }
    function saveNotes(){
      try { localStorage.setItem(key, notesEl.value || ""); } catch {}
      savedLine.textContent = "Saved: " + new Date().toLocaleString();
    }

    loadNotes();
    savedLine.textContent = notesEl.value ? ("Loaded: " + new Date().toLocaleString()) : "";

    let timer = null;
    notesEl.addEventListener("input", () => {
      clearTimeout(timer);
      timer = setTimeout(saveNotes, 300);
    });

    clearNotesBtn.addEventListener("click", () => {
      notesEl.value = "";
      saveNotes();
      showToast("Notes cleared");
    });
  }

  // Swap
  document.getElementById("swapBtn").addEventListener("click", () => {
    if (!leftId || !rightId) return;
    const u = new URL(location.href);
    u.searchParams.set("left", rightId);
    u.searchParams.set("right", leftId);
    if (t1 || t2) {
      u.searchParams.set("t1", t2);
      u.searchParams.set("t2", t1);
    }
    location.href = u.toString();
  });

  // Copy link
  document.getElementById("copyBtn").addEventListener("click", async () => {
    try {
      await navigator.clipboard.writeText(location.href);
      showToast("Compare link copied");
    } catch {
      alert("Copy failed. You can copy from the address bar.");
    }
  });
</script>
</body>
</html>
