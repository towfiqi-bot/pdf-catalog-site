<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>dotdock — Find your dots. Feed your curiosity</title>

  <!-- Font + Tailwind CDN -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    .brand-title { font-family: 'Playfair Display', serif; letter-spacing: 0.03em; }
    .brand-tagline { font-size: 0.7rem; letter-spacing: 0.18em; text-transform: uppercase; }
    .tooltip-summary { pointer-events: none; }
    .group:hover .tooltip-summary { pointer-events: auto; }
  </style>
</head>

<body class="bg-gray-50">
  <!-- Header -->
  <header class="bg-white border-b border-gray-200 shadow-sm sticky top-0 z-50">
    <div class="max-w-6xl mx-auto px-4 py-4">
      <div class="flex items-center gap-4">
        <a href="#top" class="block">
          <img src="logo.png"
               alt="dotdock logo"
               class="h-12 w-12 md:h-16 md:w-16 rounded-full object-cover shadow-md border border-gray-200 bg-white">
        </a>

        <div>
  <h1 class="brand-title text-2xl md:text-3xl font-semibold text-gray-900 tracking-tight">
    dotdock
  </h1>
  <p class="brand-tagline mt-1 text-amber-600 text-[10px] md:text-xs font-semibold uppercase tracking-[0.14em] not-italic">
    Find your dots. Feed your curiosity
  </p>
</div>
  </header>

  <!-- Main layout -->
  <main class="max-w-6xl mx-auto px-4 py-6 grid grid-cols-1 md:grid-cols-12 gap-6">
    <!-- Sidebar -->
    <aside class="md:col-span-3 space-y-6 md:sticky md:top-28 self-start">
      <!-- Keyword search -->
      <section class="bg-white rounded-lg border border-gray-200 p-4">
        <h2 class="text-sm font-semibold text-gray-700 mb-2">Keywords</h2>
        <div class="flex flex-col sm:flex-row gap-2">
          <input id="searchInput" type="text"
                 class="flex-1 border rounded px-2 py-1 text-sm w-full"
                 placeholder="Title, summary..." />
          <button id="searchBtn"
                  class="shrink-0 px-3 py-1 text-sm bg-amber-600 text-white rounded hover:bg-amber-700 w-full sm:w-auto sm:min-w-[84px]">
            Search
          </button>
        </div>
      </section>

      <!-- Refresh list -->
      <section class="bg-white rounded-lg border border-gray-200 p-4">
        <button id="userRefreshBtn"
                class="w-full px-3 py-1.5 text-sm bg-blue-600 text-white rounded hover:bg-blue-700">
          Refresh list
        </button>
        <div id="userRefreshStatus" class="text-xs text-gray-500 mt-2"></div>
      </section>


      <!-- Reading list -->
      <section class="bg-white rounded-lg border border-gray-200 p-4">
        <div class="flex items-center justify-between">
          <h2 class="text-sm font-semibold text-gray-700">Reading list</h2>
          <button id="toggleReadingList"
                  class="text-xs font-semibold text-amber-700 hover:underline">
            Show
          </button>
        </div>

        <div id="readingListEmpty" class="text-xs text-gray-500 mt-2">
          No items yet. Click “Add to reading list” on any card.
        </div>

        <div id="readingListWrap" class="hidden mt-3 space-y-2"></div>

        <div class="mt-3 flex gap-2">
          <button id="clearReadingListBtn"
                  class="px-3 py-1.5 text-xs border border-gray-300 rounded bg-white hover:bg-gray-50">
            Clear list
          </button>
        </div>
      </section>

      <!-- Compare -->
      <section class="bg-white rounded-lg border border-gray-200 p-4">
        <div class="flex items-center justify-between">
          <h2 class="text-sm font-semibold text-gray-700">Compare</h2>
          <button id="clearCompareBtn"
                  class="text-xs font-semibold text-gray-500 hover:underline">
            Clear
          </button>
        </div>

        <div id="compareStatus" class="text-xs text-gray-500 mt-2">
          Select up to 2 reports to compare side-by-side.
        </div>

        <div id="compareListWrap" class="mt-3 space-y-2"></div>

        <button id="openCompareBtn"
                class="mt-3 w-full px-3 py-1.5 text-sm bg-amber-600 text-white rounded hover:bg-amber-700 disabled:opacity-40 disabled:cursor-not-allowed"
                disabled>
          Open compare
        </button>
      </section>

      <!-- My workspace -->
      <section class="bg-white rounded-lg border border-gray-200 p-4">
        <h2 class="text-sm font-semibold text-gray-700 mb-2">My workspace</h2>

        <label class="block text-xs text-gray-600 mb-1">Status filter</label>
        <select id="wsStatusFilter"
                class="w-full border rounded px-2 py-1 text-sm">
          <option value="all">All</option>
          <option value="unread">Unread</option>
          <option value="reading">Reading</option>
          <option value="done">Done</option>
        </select>

        <label class="block text-xs text-gray-600 mt-3 mb-1">Tag filter</label>
        <input id="wsTagFilter" type="text"
               class="w-full border rounded px-2 py-1 text-sm"
               placeholder="e.g., energy, tpm" />

        <button id="exportWorkspaceBtn"
                class="mt-3 w-full px-3 py-1.5 text-sm border border-gray-300 rounded bg-white hover:bg-gray-50">
          Export my workspace
        </button>

        <div class="text-[11px] text-gray-500 mt-2">
          Saved locally in your browser (no login).
        </div>
      </section>

      <!-- Category filters -->
      <section class="bg-white rounded-lg border border-gray-200 p-4">
        <h2 class="text-sm font-semibold text-gray-700 mb-3">Filter By Category</h2>
        <div id="categoryFilters" class="space-y-1 text-sm max-h-64 overflow-y-auto"></div>
      </section>

      <!-- Year filters -->
      <section class="bg-white rounded-lg border border-gray-200 p-4">
        <h2 class="text-sm font-semibold text-gray-700 mb-3">Filter By Year</h2>
        <div id="yearFilters" class="space-y-1 text-sm max-h-64 overflow-y-auto"></div>
      </section>

      <!-- Clear filters -->
      <button id="clearFilters"
              class="w-full text-sm border border-gray-300 rounded-md py-1.5 bg-white hover:bg-gray-50">
        Clear all filters
      </button>
    </aside>

    <!-- Catalogue -->
    <section class="md:col-span-9">
      <p id="resultsInfo" class="text-sm text-gray-600 mb-3">Loading publications…</p>
      <div id="cardsContainer" class="grid grid-cols-1 lg:grid-cols-2 gap-6"></div>
      <div id="loadMoreWrap" class="mt-6"></div>
    </section>
  </main>

  <button id="backToTop"
          class="hidden fixed bottom-4 right-4 z-40 rounded-full bg-amber-600 text-white shadow-lg p-3 hover:bg-amber-700 transition">
    ↑
  </button>

  <!-- PDF Modal -->
  <div id="pdfModal" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/60" id="pdfModalBackdrop"></div>

    <div class="relative max-w-6xl mx-auto h-full p-3 md:p-6 flex flex-col">
      <div class="bg-white rounded-lg shadow-xl overflow-hidden flex flex-col h-full">
        <div class="flex items-center gap-3 px-4 py-3 border-b border-gray-200">
          <div class="font-semibold text-gray-900 truncate" id="pdfModalTitle">Report</div>
          <div class="ml-auto flex gap-2">
            <!-- Note: no "Open report page" button (title already does that) -->
            <a id="pdfModalDownload" href="#" target="_blank" rel="noopener"
               class="px-3 py-1.5 text-sm bg-amber-600 text-white rounded hover:bg-amber-700">
              View PDF (new tab)
            </a>
            <button id="pdfModalClose"
                    class="px-3 py-1.5 text-sm border border-gray-300 rounded bg-white hover:bg-gray-50">
              Close
            </button>
          </div>
        </div>

        <iframe id="pdfModalFrame"
                class="w-full flex-1"
                title="PDF viewer"
                src=""
                loading="lazy"></iframe>
      </div>
    </div>
  </div>

<script>
  // ✅ GitHub Pages: use Apps Script JSON
  const DATA_URL = "https://script.google.com/macros/s/AKfycbwF2IqDTG0F5acy4K1mtBRMZg1AOp3RMHzYwHEtZcZmRV8Jbpb2_ETe4Mpnkgp-lxmy/exec";

  // Browser cache for instant load
  const CACHE_KEY = "pdf_catalog_cache_v2";
  const CACHE_TTL_MS = 12 * 60 * 60 * 1000;

  function cacheSet(data) {
    try { localStorage.setItem(CACHE_KEY, JSON.stringify({ time: Date.now(), data })); } catch (e) {}
  }
  function cacheGet() {
    try {
      const raw = localStorage.getItem(CACHE_KEY);
      if (!raw) return null;
      const parsed = JSON.parse(raw);
      if (!parsed?.time || !parsed?.data) return null;
      if (Date.now() - parsed.time > CACHE_TTL_MS) return null;
      return parsed.data;
    } catch { return null; }
  }


  // --- Reading list (localStorage) ---
  const READING_KEY = "dotdock_reading_list_v1";
  function readingGet() {
    try {
      const raw = localStorage.getItem(READING_KEY);
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr.map(String) : [];
    } catch { return []; }
  }
  function readingSet(arr) {
    try {
      localStorage.setItem(READING_KEY, JSON.stringify(Array.from(new Set(arr.map(String)))));
    } catch {}
  }
  function isInReadingList(id) { return readingGet().includes(String(id)); }
  window.isInReadingList = isInReadingList;

  function toggleReadingList(id) {
    const list = readingGet();
    const sid = String(id);
    const idx = list.indexOf(sid);
    if (idx >= 0) list.splice(idx, 1);
    else list.unshift(sid);
    readingSet(list);
    updateReadingListUI();
    render();
  }
  window.toggleReadingList = toggleReadingList;

  function removeFromReadingList(id) {
    const list = readingGet().filter(x => x !== String(id));
    readingSet(list);
    updateReadingListUI();
    render();
  }
  window.removeFromReadingList = removeFromReadingList;

  // --- Compare (localStorage) ---
  const COMPARE_KEY = "dotdock_compare_v1";
  function compareGet() {
    try {
      const raw = localStorage.getItem(COMPARE_KEY);
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr.map(String) : [];
    } catch { return []; }
  }
  function compareSet(arr) {
    try { localStorage.setItem(COMPARE_KEY, JSON.stringify(arr.map(String).slice(0, 2))); } catch {}
  }
  function isInCompare(id) { return compareGet().includes(String(id)); }
  window.isInCompare = isInCompare;

  function compareToggle(id) {
    const sid = String(id);
    const list = compareGet();
    const idx = list.indexOf(sid);
    if (idx >= 0) list.splice(idx, 1);
    else {
      if (list.length >= 2) list.pop();
      list.unshift(sid);
    }
    compareSet(list);
    updateCompareUI();
    render();
  }
  window.compareToggle = compareToggle;

  function compareClear() {
    compareSet([]);
    updateCompareUI();
    render();
  }
  window.compareClear = compareClear;

  // --- Personal workspace (localStorage) ---
  const WORKSPACE_KEY = "dotdock_workspace_v1";
  function wsAll() {
    try {
      const raw = localStorage.getItem(WORKSPACE_KEY);
      const obj = raw ? JSON.parse(raw) : {};
      return (obj && typeof obj === "object") ? obj : {};
    } catch { return {}; }
  }
  function wsSaveAll(obj) {
    try { localStorage.setItem(WORKSPACE_KEY, JSON.stringify(obj)); } catch {}
  }
  function wsGet(id) {
    const all = wsAll();
    return all[String(id)] || null;
  }
  function wsSet(id, patch) {
    const sid = String(id);
    const all = wsAll();
    const cur = all[sid] || { status: "unread", tags: [], notes: "", pinned: false, updated: 0 };
    const next = { ...cur, ...patch, updated: Date.now() };
    all[sid] = next;
    wsSaveAll(all);
  }
  function wsTogglePin(id) {
    const cur = wsGet(id) || { status: "unread", tags: [], notes: "", pinned: false, updated: 0 };
    wsSet(id, { pinned: !cur.pinned });
    render();
  }
  window.wsTogglePin = wsTogglePin;

  function wsStatusLabel(status) {
    if (status === "done") return "Done";
    if (status === "reading") return "Reading";
    if (status === "unread") return "Unread";
    return "";
  }

  // --- Toast ---
  function showToast(msg) {
    const t = document.getElementById("toast");
    if (!t) return;
    t.textContent = msg;
    t.classList.remove("hidden");
    clearTimeout(showToast._t);
    showToast._t = setTimeout(() => t.classList.add("hidden"), 1400);
  }

  // --- NotebookLM helper ---
  function driveShareUrl(fileId) {
    return `https://drive.google.com/file/d/${encodeURIComponent(fileId)}/view?usp=sharing`;
  }
  async function openNotebookLM(fileId) {
    const url = driveShareUrl(fileId);
    try { await navigator.clipboard.writeText(url); showToast("Link copied for NotebookLM"); } catch { showToast("Copy failed — use address bar"); }
    window.open("https://notebooklm.google.com/", "_blank", "noopener");
  }
  window.openNotebookLM = openNotebookLM;

  function exportWorkspace() {
    const payload = {
      exportedAt: new Date().toISOString(),
      readingList: readingGet(),
      compare: compareGet(),
      workspace: wsAll()
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `dotdock_workspace_${new Date().toISOString().slice(0,10)}.json`;
    document.body.appendChild(a);
    a.click();
    setTimeout(() => { URL.revokeObjectURL(a.href); a.remove(); }, 250);
  }

  const state = {
    allItems: [],
    filteredItems: [],
    selectedCategories: new Set(),
    selectedYears: new Set(),
    searchQuery: "",
    page: 1,
    pageSize: 50,
    wsStatusFilter: "all",
    wsTagFilter: "",
  };

  function escapeHtml(str) {
    return String(str || "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function formatTime(ts) {
    const d = new Date(ts);
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    const hh = String(d.getHours()).padStart(2, "0");
    const mi = String(d.getMinutes()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
  }

  async function loadData(forceFresh = false) {
    const url = forceFresh
      ? DATA_URL + (DATA_URL.includes("?") ? "&" : "?") + "cb=" + Date.now()
      : DATA_URL;

    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error(`Failed to load catalog (${res.status})`);
    return await res.json();
  }

  // --- URL helpers ---
  function drivePreviewUrl(fileId) {
    return `https://drive.google.com/file/d/${encodeURIComponent(fileId)}/preview`;
  }

  // ✅ Download button should NOT download: open dotdock viewer in new tab
  function driveDownloadUrl(fileId) {
    return `report.html?id=${encodeURIComponent(fileId)}&view=1`;
  }


  function comparePageUrl(id1, id2, t1 = "", t2 = "") {
    const base = `compare.html?left=${encodeURIComponent(id1)}&right=${encodeURIComponent(id2)}`;
    const q1 = t1 ? `&t1=${encodeURIComponent(t1)}` : "";
    const q2 = t2 ? `&t2=${encodeURIComponent(t2)}` : "";
    return base + q1 + q2;
  }


  function reportPageUrl(fileId, titleHint = "") {
    const base = `report.html?id=${encodeURIComponent(fileId)}`;
    return titleHint ? `${base}&t=${encodeURIComponent(titleHint)}` : base;
  }

  // --- Modal ---
  function openPdfModal(item) {
    const modal = document.getElementById("pdfModal");
    const frame = document.getElementById("pdfModalFrame");
    const title = document.getElementById("pdfModalTitle");
    const viewBtn = document.getElementById("pdfModalDownload");

    title.textContent = item.title || "Report";
    frame.src = drivePreviewUrl(item.id);

    // “View PDF (new tab)” goes to dotdock, not Drive
    viewBtn.href = driveDownloadUrl(item.id);

    modal.classList.remove("hidden");
    document.body.style.overflow = "hidden";
  }

  function closePdfModal() {
    const modal = document.getElementById("pdfModal");
    const frame = document.getElementById("pdfModalFrame");
    frame.src = "";
    modal.classList.add("hidden");
    document.body.style.overflow = "";
  }

  function openPdfModalById(id) {
    const item = state.allItems.find(x => String(x.id) === String(id));
    if (item) openPdfModal(item);
  }
  window.openPdfModalById = openPdfModalById;


  // --- Reading list UI ---
  function updateReadingListUI() {
    const wrap = document.getElementById("readingListWrap");
    const empty = document.getElementById("readingListEmpty");
    const toggleBtn = document.getElementById("toggleReadingList");
    if (!wrap || !empty || !toggleBtn) return;

    const list = readingGet();
    toggleBtn.textContent = (wrap.classList.contains("hidden") ? "Show" : "Hide") + ` (${list.length})`;

    if (list.length === 0) {
      empty.classList.remove("hidden");
      wrap.innerHTML = "";
      return;
    }

    empty.classList.add("hidden");

    const items = list
      .map(id => state.allItems.find(x => String(x.id) === String(id)))
      .filter(Boolean);

    wrap.innerHTML = items.map(item => `
      <div class="flex items-start justify-between gap-2 border border-gray-200 rounded p-2 bg-gray-50">
        <div class="min-w-0">
          <a class="text-sm font-semibold text-amber-700 hover:underline block truncate"
             href="${reportPageUrl(item.id, item.title || "")}">
            ${escapeHtml(item.title || "Untitled")}
          </a>
          <div class="text-xs text-gray-500 mt-0.5">${escapeHtml(item.year || "")}</div>
          <div class="mt-1 flex gap-2">
            <button class="text-xs text-gray-700 hover:underline"
                    onclick="openPdfModalById('${item.id}')">Preview</button>
            <a class="text-xs text-gray-700 hover:underline" target="_blank" rel="noopener"
               href="${driveDownloadUrl(item.id)}">View</a>
          </div>
        </div>
        <button class="text-xs text-gray-500 hover:text-gray-800"
                title="Remove"
                onclick="removeFromReadingList('${item.id}')">✕</button>
      </div>
    `).join("");
  }

  // --- Compare UI ---
  function updateCompareUI() {
    const status = document.getElementById("compareStatus");
    const wrap = document.getElementById("compareListWrap");
    const openBtn = document.getElementById("openCompareBtn");
    if (!status || !wrap || !openBtn) return;

    const list = compareGet();
    openBtn.disabled = list.length !== 2;

    if (list.length === 0) {
      status.textContent = "Select up to 2 reports to compare side-by-side.";
      wrap.innerHTML = "";
      return;
    }

    status.textContent = list.length === 1
      ? "Select one more report to enable compare."
      : "Ready to compare.";

    const items = list
      .map(id => state.allItems.find(x => String(x.id) === String(id)))
      .filter(Boolean);

    wrap.innerHTML = items.map(item => `
      <div class="flex items-start justify-between gap-2 border border-gray-200 rounded p-2 bg-gray-50">
        <div class="min-w-0">
          <div class="text-sm font-semibold text-gray-900 truncate">${escapeHtml(item.title || "Untitled")}</div>
          <div class="text-xs text-gray-500">${escapeHtml(item.year || "")}</div>
        </div>
        <button class="text-xs text-gray-500 hover:text-gray-800" title="Remove"
                onclick="compareToggle('${item.id}')">✕</button>
      </div>
    `).join("");

    openBtn.onclick = () => {
      const [a, b] = list;
      const ia = state.allItems.find(x => String(x.id) === String(a));
      const ib = state.allItems.find(x => String(x.id) === String(b));
      const url = comparePageUrl(a, b, ia?.title || "", ib?.title || "");
      window.open(url, "_blank", "noopener");
    };
  }


  // --- Facets / filtering ---
  function buildFacetFilters() {
    const catCounts = new Map();
    const yearCounts = new Map();

    state.allItems.forEach(item => {
      (item.categories || []).forEach(cat => {
        catCounts.set(cat, (catCounts.get(cat) || 0) + 1);
      });
      const y = item.year;
      if (y) yearCounts.set(y, (yearCounts.get(y) || 0) + 1);
    });

    // Categories
    const catContainer = document.getElementById("categoryFilters");
    catContainer.innerHTML = "";
    Array.from(catCounts.entries())
      .sort((a, b) => a[0].localeCompare(b[0]))
      .forEach(([cat, count]) => {
        const id = "cat-" + cat.replace(/\W+/g, "-").toLowerCase();
        const row = document.createElement("div");
        row.className = "flex items-center gap-2";
        row.innerHTML = `
          <input type="checkbox" id="${id}" value="${escapeHtml(cat)}"
                 class="h-3 w-3 text-amber-600 border-gray-300 rounded">
          <label for="${id}" class="cursor-pointer text-gray-700">
            ${escapeHtml(cat)} <span class="text-gray-400 text-xs">(${count})</span>
          </label>
        `;
        const checkbox = row.querySelector("input");
	        // Preserve UI state when rebuilding facets (e.g., after Refresh list)
	        checkbox.checked = state.selectedCategories.has(cat);
        checkbox.addEventListener("change", () => {
          checkbox.checked ? state.selectedCategories.add(cat) : state.selectedCategories.delete(cat);
          applyFilters();
        });
        catContainer.appendChild(row);
      });

    // Years
    const yearContainer = document.getElementById("yearFilters");
    yearContainer.innerHTML = "";
    Array.from(yearCounts.entries())
      .sort((a, b) => b[0] - a[0])
      .forEach(([year, count]) => {
        const id = "year-" + year;
        const row = document.createElement("div");
        row.className = "flex items-center gap-2";
        row.innerHTML = `
          <input type="checkbox" id="${id}" value="${year}"
                 class="h-3 w-3 text-amber-600 border-gray-300 rounded">
          <label for="${id}" class="cursor-pointer text-gray-700">
            ${year} <span class="text-gray-400 text-xs">(${count})</span>
          </label>
        `;
        const checkbox = row.querySelector("input");
	        // Preserve UI state when rebuilding facets (e.g., after Refresh list)
	        checkbox.checked = state.selectedYears.has(String(year));
        checkbox.addEventListener("change", () => {
          checkbox.checked ? state.selectedYears.add(String(year)) : state.selectedYears.delete(String(year));
          applyFilters();
        });
        yearContainer.appendChild(row);
      });
  }

  function applyFilters() {
    const q = state.searchQuery.toLowerCase().trim();
    const statusFilter = state.wsStatusFilter;
    const tagFilter = (state.wsTagFilter || "").toLowerCase().trim();

    state.filteredItems = state.allItems.filter(item => {
      const matchesText = !q ||
        (item.title || "").toLowerCase().includes(q) ||
        (item.summary || "").toLowerCase().includes(q);

      const matchesCat = state.selectedCategories.size === 0 ||
        (item.categories || []).some(c => state.selectedCategories.has(c));

      const matchesYear = state.selectedYears.size === 0 ||
        state.selectedYears.has(String(item.year));

      // Workspace filters
      if (statusFilter !== "all" || tagFilter) {
        const ws = wsGet(item.id) || { status: "unread", tags: [], pinned: false };
        if (statusFilter !== "all") {
          const st = (ws.status || "unread");
          if (st !== statusFilter) return false;
        }
        if (tagFilter) {
          const tags = Array.isArray(ws.tags) ? ws.tags : [];
          const hit = tags.some(t => String(t || "").toLowerCase().includes(tagFilter));
          if (!hit) return false;
        }
      }

      return matchesText && matchesCat && matchesYear;
    });

    // Pinned first (workspace)
    state.filteredItems.sort((a, b) => {
      const ap = (wsGet(a.id)?.pinned) ? 1 : 0;
      const bp = (wsGet(b.id)?.pinned) ? 1 : 0;
      if (ap !== bp) return bp - ap;
      return (b.modified || 0) - (a.modified || 0);
    });

    state.page = 1;
    render();
    updateCompareUI();
    updateReadingListUI();
  }

  function renderCard(item) {
    const thumb = item.thumbUrl || "https://via.placeholder.com/260x360?text=PDF";
    const titleRaw = item.title || "Untitled";
    const title = escapeHtml(titleRaw);
    const summary = escapeHtml(item.summary || "");
    const year = item.year || "";
    const reportUrl = reportPageUrl(item.id, titleRaw);
    const viewUrl = driveDownloadUrl(item.id);

    const ws = wsGet(item.id) || { status: "unread", pinned: false };
    const status = wsStatusLabel(ws.status || "unread");
    const pinned = !!ws.pinned;

    const cats = (item.categories || [])
      .map(c => `<span class="px-2 py-0.5 border rounded-full bg-gray-50">${escapeHtml(c)}</span>`)
      .join("");

    const inList = isInReadingList(item.id);
    const inCompare = isInCompare(item.id);

    return `
      <article class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm hover:shadow transition">
        <div class="grid grid-cols-1 sm:grid-cols-[160px,1fr] gap-4">
          <div class="w-full">
            <div class="relative border border-gray-200 bg-white rounded group">
              <button type="button" onclick="openPdfModalById('${item.id}')" class="block w-full text-left">
                <img src="${thumb}" alt="${title}" loading="lazy" decoding="async" referrerpolicy="no-referrer"
                     onerror="this.onerror=null;this.src='https://via.placeholder.com/260x360?text=PDF';"
                     class="w-full h-auto object-cover cursor-pointer group-hover:opacity-80 transition">
              </button>

              ${summary ? `
                <div class="tooltip-summary absolute left-0 top-0 z-20 w-80 md:w-96 bg-white/95
                            text-xs text-gray-800 p-3 opacity-0 group-hover:opacity-100
                            transition-opacity duration-200 shadow-lg ring-1 ring-black/10">
                  <div class="font-semibold mb-1">Summary</div>
                  <div class="leading-snug whitespace-normal">${summary}</div>
                </div>
              ` : ""}
            </div>
          </div>

          <div class="flex flex-col">
            <div class="flex items-center gap-2 text-xs text-gray-500 mb-1">
              <span>${escapeHtml(year)}</span>
              ${status ? `<span class="px-2 py-0.5 rounded-full border border-gray-200 bg-gray-50 text-gray-700">${status}</span>` : ``}
              ${pinned ? `<span title="Pinned" class="text-amber-600">★</span>` : ``}
            </div>

            <a href="${reportUrl}"
               class="text-base md:text-lg font-semibold text-amber-700 hover:underline">
              ${title}
            </a>

            <div class="mt-3 flex flex-wrap gap-2 text-xs text-gray-500">${cats}</div>

            <div class="mt-3 flex flex-wrap gap-2">
              <button type="button"
                      onclick="toggleReadingList('${item.id}')"
                      class="inline-flex items-center px-3 py-1.5 text-xs font-semibold border border-gray-300 rounded bg-white hover:bg-gray-50">
                ${inList ? "Saved" : "Add to reading list"}
              </button>

              <button type="button"
                      onclick="compareToggle('${item.id}')"
                      class="inline-flex items-center px-3 py-1.5 text-xs font-semibold border border-gray-300 rounded bg-white hover:bg-gray-50">
                ${inCompare ? "Selected" : "Compare"}
              </button>

              <button type="button"
                      onclick="openNotebookLM('${item.id}')"
                      class="inline-flex items-center px-3 py-1.5 text-xs font-semibold border border-gray-300 rounded bg-white hover:bg-gray-50">
                NotebookLM
              </button>

              <button type="button"
                      onclick="wsTogglePin('${item.id}')"
                      class="inline-flex items-center px-3 py-1.5 text-xs font-semibold border border-gray-300 rounded bg-white hover:bg-gray-50">
                ${pinned ? "Unpin" : "Pin"}
              </button>

              <a href="${viewUrl}" target="_blank" rel="noopener"
                 class="inline-flex items-center px-3 py-1.5 text-xs font-semibold border border-gray-300 rounded bg-white hover:bg-gray-50">
                View
              </a>
            </div>
          </div>
        </div>
      </article>
    `;
  }

  function render() {
    const container = document.getElementById("cardsContainer");
    const info = document.getElementById("resultsInfo");
    const loadMoreWrap = document.getElementById("loadMoreWrap");

    const total = state.filteredItems.length;
    const maxShown = state.page * state.pageSize;
    const itemsToShow = state.filteredItems.slice(0, maxShown);

    info.textContent = `${total} publication(s) found`;
    container.innerHTML = itemsToShow.map(renderCard).join("");

    loadMoreWrap.innerHTML = "";
    if (maxShown < total) {
      const btn = document.createElement("button");
      btn.textContent = "Load more";
      btn.className = "mx-auto block px-4 py-2 text-sm border border-gray-300 rounded bg-white hover:bg-gray-50";
      btn.onclick = () => { state.page += 1; render(); };
      loadMoreWrap.appendChild(btn);
    }
  }

  document.addEventListener("DOMContentLoaded", async () => {
    const searchInput = document.getElementById("searchInput");
    const searchBtn = document.getElementById("searchBtn");
    const clearBtn = document.getElementById("clearFilters");
    const refreshBtn = document.getElementById("userRefreshBtn");
    const refreshStatus = document.getElementById("userRefreshStatus");
    const backToTopBtn = document.getElementById("backToTop");

    // Modal close handlers
    document.getElementById("pdfModalClose").addEventListener("click", closePdfModal);
    document.getElementById("pdfModalBackdrop").addEventListener("click", closePdfModal);
    document.addEventListener("keydown", (e) => { if (e.key === "Escape") closePdfModal(); });


    // Reading list UI
    const toggleReadingListBtn = document.getElementById("toggleReadingList");
    const readingListWrap = document.getElementById("readingListWrap");
    const clearReadingListBtn = document.getElementById("clearReadingListBtn");

    toggleReadingListBtn?.addEventListener("click", () => {
      const hidden = readingListWrap.classList.toggle("hidden");
      toggleReadingListBtn.textContent = (hidden ? "Show" : "Hide") + ` (${readingGet().length})`;
      if (!hidden) updateReadingListUI();
    });

    clearReadingListBtn?.addEventListener("click", () => {
      readingSet([]);
      updateReadingListUI();
      render();
    });

    // Compare UI
    document.getElementById("clearCompareBtn")?.addEventListener("click", () => {
      compareClear();
      showToast("Compare cleared");
    });

    // Workspace filters + export
    const wsStatusFilterEl = document.getElementById("wsStatusFilter");
    const wsTagFilterEl = document.getElementById("wsTagFilter");
    const exportBtn = document.getElementById("exportWorkspaceBtn");

    wsStatusFilterEl?.addEventListener("change", () => {
      state.wsStatusFilter = wsStatusFilterEl.value;
      applyFilters();
    });

    let tagTimer = null;
    wsTagFilterEl?.addEventListener("input", () => {
      clearTimeout(tagTimer);
      tagTimer = setTimeout(() => {
        state.wsTagFilter = wsTagFilterEl.value;
        applyFilters();
      }, 250);
    });

    exportBtn?.addEventListener("click", exportWorkspace);

    // Search
    searchBtn.addEventListener("click", () => {
      state.searchQuery = searchInput.value.trim();
      applyFilters();
    });

    // Live search debounce
    let searchTimeout = null;
    searchInput.addEventListener("input", () => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        state.searchQuery = searchInput.value.trim();
        applyFilters();
      }, 250);
    });

    // Clear filters
    clearBtn.addEventListener("click", () => {
      state.searchQuery = "";
      searchInput.value = "";
      state.selectedCategories.clear();
      state.selectedYears.clear();
      document.querySelectorAll("#categoryFilters input[type=checkbox], #yearFilters input[type=checkbox]")
        .forEach(cb => cb.checked = false);
      applyFilters();
    });

    // Refresh list (fetch latest JSON from Apps Script)
    refreshBtn.addEventListener("click", async () => {
      refreshStatus.textContent = "Refreshing…";
      try {
        const data = await loadData(true);
        state.allItems = data;
        cacheSet(data);
        buildFacetFilters();
        applyFilters();
        refreshStatus.textContent = "Last updated: " + formatTime(Date.now());
      } catch (e) {
        refreshStatus.textContent = e.message;
      }
    });

    // Back-to-top
    window.addEventListener("scroll", () => {
      if (window.scrollY > 300) backToTopBtn.classList.remove("hidden");
      else backToTopBtn.classList.add("hidden");
    });
    backToTopBtn.addEventListener("click", () => window.scrollTo({ top: 0, behavior: "smooth" }));

    // Instant-load cached data
    const cached = cacheGet();
    if (cached) {
      state.allItems = cached;
      buildFacetFilters();
      applyFilters();
      updateReadingListUI();
      updateCompareUI();
      document.getElementById("resultsInfo").textContent = "Showing cached results… updating";
    }

    // Fetch fresh
    try {
      const data = await loadData(false);
      state.allItems = data;
      cacheSet(data);
      buildFacetFilters();
      applyFilters();
      updateReadingListUI();
      updateCompareUI();
    } catch (e) {
      if (!cached) {
        document.getElementById("resultsInfo").textContent = "Error loading data: " + e.message;
      }
    }
  });
</script>

  <div id="toast"
       class="hidden fixed bottom-4 left-1/2 -translate-x-1/2 z-50 bg-gray-900 text-white text-sm px-4 py-2 rounded shadow-lg">
    Copied
  </div>

</body>
</html>
