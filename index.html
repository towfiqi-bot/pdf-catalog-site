<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>dotdock — Find your dots. Feed your curiosity</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    .brand-title { font-family: 'Playfair Display', serif; letter-spacing: 0.03em; }
    .brand-tagline { font-size: 0.7rem; letter-spacing: 0.18em; text-transform: uppercase; }
    .tooltip-summary { pointer-events: none; }
    .group:hover .tooltip-summary { pointer-events: auto; }
  </style>
</head>

<body class="bg-gray-50" id="top">
  <!-- Header -->
  <header class="bg-white border-b border-gray-200 shadow-sm sticky top-0 z-50">
    <div class="max-w-6xl mx-auto px-4 py-4">
      <div class="flex items-center gap-4">
        <a href="#top" class="block" aria-label="Back to top">
          <img src="logo.png"
               alt="dotdock logo"
               class="h-12 w-12 md:h-16 md:w-16 rounded-full object-cover shadow-md border border-gray-200 bg-white">
        </a>

        <div>
          <h1 class="brand-title text-2xl md:text-3xl font-semibold text-gray-900 tracking-tight">dotdock</h1>
          <p class="brand-tagline mt-1 text-amber-600 text-[10px] md:text-xs font-semibold uppercase tracking-[0.14em] not-italic">
            Find your dots. Feed your curiosity
          </p>
        </div>
      </div>
    </div>
  </header>

  <!-- Main layout -->
  <main class="max-w-6xl mx-auto px-4 py-6" id="top">
    <!-- Top search -->
    <section class="mb-6">
      <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
        <div class="max-w-3xl mx-auto">
          <div class="flex items-center gap-3 bg-white border border-gray-300 rounded-full px-5 py-3 shadow-sm focus-within:ring-2 focus-within:ring-amber-200">
            <svg class="h-5 w-5 text-gray-400 shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="7"></circle>
              <path d="M21 21l-4.3-4.3"></path>
            </svg>
            <input id="searchInput" type="text"
                   class="w-full outline-none text-base md:text-lg"
                   placeholder="Search reports by title or summary…" />
            <button id="searchBtn"
                    class="shrink-0 px-5 py-2 text-sm font-semibold uppercase tracking-wide bg-amber-600 text-white rounded-full hover:bg-amber-700">
              Search
            </button>
          </div>
          <p class="mt-2 text-xs text-gray-500 text-center">
            Searches <span class="font-semibold">title</span> + <span class="font-semibold">summary</span> (not inside PDF pages).
          </p>
        </div>
      </div>
    </section>

    <div class="grid grid-cols-1 md:grid-cols-12 gap-6">

      <!-- Sidebar -->
      <aside class="md:col-span-3 space-y-6 md:sticky md:top-28 self-start md:max-h-[calc(100vh-7rem)] md:overflow-auto md:pr-1">
        <!-- Filters -->
        <section class="bg-white rounded-lg border border-gray-200 p-4">
          <h2 class="text-sm font-semibold text-gray-700 mb-2">Filters</h2>

          <div class="space-y-4">

            <!-- Topics filters (RESTORED) -->
            <div>
              <div class="flex items-center justify-between">
                <h3 class="text-xs font-semibold text-gray-700">Topics</h3>
                <button id="toggleTopics" class="text-xs font-semibold text-amber-700 hover:underline">Show</button>
              </div>
              <div id="topicFilters" class="hidden mt-2 grid grid-cols-2 gap-x-4 gap-y-2 text-sm max-h-72 overflow-y-auto overflow-x-hidden pr-1"></div>
              <div class="mt-2 text-[11px] text-gray-500">Auto-generated from report titles.</div>
            </div>

            <!-- Category filters -->
            <div>
              <div class="flex items-center justify-between">
                <h3 class="text-xs font-semibold text-gray-700">Category</h3>
                <button id="toggleCats" class="text-xs font-semibold text-amber-700 hover:underline">Show</button>
              </div>
              <div id="categoryFilters" class="hidden mt-2 space-y-1 text-sm max-h-56 overflow-y-auto"></div>
            </div>

            <!-- Year filters -->
            <div>
              <div class="flex items-center justify-between">
                <h3 class="text-xs font-semibold text-gray-700">Year</h3>
                <button id="toggleYears" class="text-xs font-semibold text-amber-700 hover:underline">Show</button>
              </div>
              <div id="yearFilters" class="hidden mt-2 space-y-1 text-sm max-h-56 overflow-y-auto"></div>
            </div>
          </div>
        </section>

        <!-- Newsletter -->
        <section class="bg-white rounded-lg border border-gray-200 p-4">
          <button id="newsletterBtn" class="w-full flex items-center justify-center gap-2 px-3 py-2 rounded-md border border-blue-300 text-blue-700 font-semibold hover:bg-blue-50">
            <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M4 4h16v16H4z" opacity="0"/>
              <path d="M4 4h16v16H4z"/>
              <path d="M22 6l-10 7L2 6"/>
            </svg>
            <span>Join the free newsletter</span>
          </button>
          <div class="mt-2 text-[11px] text-gray-500">We’ll set the signup link later.</div>
        </section>

        <!-- Refresh list -->
        <section class="bg-white rounded-lg border border-gray-200 p-4">
          <button id="userRefreshBtn"
                  class="w-full px-3 py-1.5 text-sm bg-blue-600 text-white rounded hover:bg-blue-700">
            Refresh list
          </button>
          <div id="userRefreshStatus" class="text-xs text-gray-500 mt-2"></div>
        </section>

        <!-- Reading list -->
        <section class="bg-white rounded-lg border border-gray-200 p-4">
          <div class="flex items-center justify-between">
            <h2 class="text-sm font-semibold text-gray-700">Reading list</h2>
            <button id="toggleReadingList"
                    class="text-xs font-semibold text-amber-700 hover:underline">
              Show
            </button>
          </div>

          <div id="readingListEmpty" class="text-xs text-gray-500 mt-2">
            No items yet. Click “Add to reading list” on any card.
          </div>

          <div id="readingListWrap" class="hidden mt-3 space-y-2"></div>

          <div class="mt-3 flex gap-2">
            <button id="clearReadingListBtn"
                    class="px-3 py-1.5 text-xs border border-gray-300 rounded bg-white hover:bg-gray-50">
              Clear list
            </button>
          </div>
        </section>

        <!-- Compare -->
        <section class="bg-white rounded-lg border border-gray-200 p-4">
          <div class="flex items-center justify-between">
            <h2 class="text-sm font-semibold text-gray-700">Compare</h2>
            <button id="clearCompareBtn" class="text-xs font-semibold text-amber-700 hover:underline">Clear</button>
          </div>
          <div class="text-xs text-gray-500 mt-1">Select 2 reports to compare side-by-side.</div>

          <div id="compareWrap" class="mt-3 space-y-2"></div>

          <a id="openCompareBtn"
             class="hidden mt-3 w-full text-center block px-3 py-2 text-sm font-semibold bg-amber-600 text-white rounded hover:bg-amber-700"
             href="#">
            Open compare
          </a>
        </section>

        <!-- My workspace (filters + export) -->
        <section class="bg-white rounded-lg border border-gray-200 p-4">
          <div class="flex items-center justify-between">
            <h2 class="text-sm font-semibold text-gray-700">My workspace</h2>
          </div>

          <label class="block text-xs text-gray-600 mt-3">Status filter</label>
          <select id="wsStatusFilter" class="mt-1 w-full border border-gray-300 rounded px-2 py-1 text-sm bg-white">
            <option value="all">All</option>
            <option value="unread">Unread</option>
            <option value="reading">Reading</option>
            <option value="done">Done</option>
          </select>

          <label class="block text-xs text-gray-600 mt-3">Tag filter</label>
          <input id="wsTagFilter" type="text"
                 class="mt-1 w-full border border-gray-300 rounded px-2 py-1 text-sm"
                 placeholder="e.g., energy, tpm" />

          <button id="exportWorkspaceBtn"
                  class="mt-3 w-full px-3 py-2 text-sm border border-gray-300 rounded bg-white hover:bg-gray-50">
            Export my workspace
          </button>

          <div class="text-[11px] text-gray-500 mt-2">
            Saved locally in your browser (no login).
          </div>
        </section>

        <!-- Clear filters -->
        <button id="clearFilters"
                class="w-full text-sm border border-gray-300 rounded-md py-1.5 bg-white hover:bg-gray-50">
          Clear all filters
        </button>
      </aside>

      <!-- Catalogue -->
      <section class="md:col-span-9">
        <div class="flex items-center justify-between gap-3 mb-3">
          <p id="resultsInfo" class="text-sm text-gray-600">Loading publications…</p>
          <div class="flex items-center gap-2">
            <label for="sortSelect" class="text-xs text-gray-500 hidden sm:block">Sort</label>
            <select id="sortSelect" class="border border-gray-300 rounded-md px-3 py-1.5 text-sm bg-white">
              <option value="newest">Sort (Default - Newest)</option>
              <option value="upvoted">Most Upvoted</option>
              <option value="name_az">Sort By Name (A-Z)</option>
              <option value="name_za">Sort By Name (Z-A)</option>
              <option value="added_newest">Date Added (Newest-Oldest)</option>
              <option value="added_oldest">Date Added (Oldest-Newest)</option>
            </select>
          </div>
        </div>

        <div id="cardsContainer" class="grid grid-cols-1 lg:grid-cols-2 gap-6"></div>
        <div id="infiniteSentinel" class="h-1"></div>

        <footer class="mt-10 text-center text-xs text-gray-500">
          © Towfiq
        </footer>
      </section>
    </div>
  </main>

  <button id="backToTop"
          class="hidden fixed bottom-4 right-4 z-40 rounded-full bg-amber-600 text-white shadow-lg p-3 hover:bg-amber-700 transition">
    ↑
  </button>

  <!-- Toast -->
  <div id="toast" class="hidden fixed bottom-4 left-1/2 -translate-x-1/2 z-[60] bg-gray-900 text-white text-sm px-4 py-2 rounded shadow-lg"></div>

  <!-- PDF Modal -->
  <div id="pdfModal" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/60" id="pdfModalBackdrop"></div>

    <div class="relative mx-auto h-full p-0 md:p-3 flex flex-col">
      <div class="bg-white shadow-xl overflow-hidden flex flex-col h-full rounded-none md:rounded-lg md:max-w-none md:w-[96vw] md:h-[92vh] md:mx-auto">
        <div class="flex items-center gap-3 px-3 md:px-4 py-2 border-b border-gray-200">
          <div class="font-semibold text-gray-900 truncate" id="pdfModalTitle">Report</div>
          <div class="ml-auto flex gap-2">
            <a id="pdfModalView"
               target="_blank" rel="noopener"
               class="px-3 py-1.5 text-sm font-semibold bg-amber-600 text-white rounded hover:bg-amber-700">
              View PDF (new tab)
            </a>
            <button id="pdfModalClose"
                    class="px-3 py-1.5 text-sm border border-gray-300 rounded bg-white hover:bg-gray-50">
              Close
            </button>
          </div>
        </div>

        <iframe id="pdfModalFrame"
                class="w-full flex-1"
                title="PDF viewer"
                src=""
                loading="lazy"></iframe>
      </div>
    </div>
  </div>

<script>
  const DATA_URL = "https://script.google.com/macros/s/AKfycbwF2IqDTG0F5acy4K1mtBRMZg1AOp3RMHzYwHEtZcZmRV8Jbpb2_ETe4Mpnkgp-lxmy/exec";

  const CACHE_KEY = "pdf_catalog_cache_v2";
  const CACHE_TTL_MS = 12 * 60 * 60 * 1000;

  const READING_KEY = "dotdock_reading_list_v1";
  const WORKSPACE_KEY = "dotdock_workspace_v1";
  const COMPARE_KEY = "dotdock_compare_v1";
  const VOTE_KEY = "dotdock_votes_v1";

  const NEWSLETTER_URL = "";

  const state = {
    allItems: [],
    filteredItems: [],
    selectedTopics: new Set(),       // ✅ added
    selectedCategories: new Set(),
    selectedYears: new Set(),
    searchQuery: "",
    page: 1,
    pageSize: 50,
    wsStatusFilter: "all",
    wsTagFilter: "",
    sortMode: "newest"
  };

  function escapeHtml(s) {
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function formatTime(ts) {
    const d = new Date(ts);
    return d.toLocaleString();
  }

  function showToast(msg) {
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.classList.remove("hidden");
    clearTimeout(showToast._to);
    showToast._to = setTimeout(() => t.classList.add("hidden"), 2200);
  }

  function drivePreviewUrl(fileId) {
    return `https://drive.google.com/file/d/${encodeURIComponent(fileId)}/preview`;
  }

  function driveShareUrl(fileId) {
    return `https://drive.google.com/file/d/${encodeURIComponent(fileId)}/view?usp=sharing`;
  }

  function reportPageUrl(fileId, title) {
    const base = `report.html?id=${encodeURIComponent(fileId)}`;
    return title ? `${base}&t=${encodeURIComponent(title)}` : base;
  }

  function viewPageUrl(fileId, title) {
    const base = `report.html?id=${encodeURIComponent(fileId)}&view=1`;
    return title ? `${base}&t=${encodeURIComponent(title)}` : base;
  }

  function cacheSet(data) {
    try { localStorage.setItem(CACHE_KEY, JSON.stringify({ time: Date.now(), data })); } catch (e) {}
  }
  function cacheGet() {
    try {
      const raw = localStorage.getItem(CACHE_KEY);
      if (!raw) return null;
      const parsed = JSON.parse(raw);
      if (!parsed?.time || !parsed?.data) return null;
      if (Date.now() - parsed.time > CACHE_TTL_MS) return null;
      return parsed.data;
    } catch { return null; }
  }

  function readingGet() {
    try {
      const raw = localStorage.getItem(READING_KEY);
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr.map(String) : [];
    } catch { return []; }
  }
  function readingSet(arr) {
    try { localStorage.setItem(READING_KEY, JSON.stringify(Array.from(new Set(arr.map(String))))); } catch {}
  }
  function toggleReadingItem(id) {
    const cur = readingGet();
    const sid = String(id);
    const next = cur.includes(sid) ? cur.filter(x => x !== sid) : [sid, ...cur];
    readingSet(next);
    renderReadingList();
    render();
  }
  function isInReadingList(id) {
    return readingGet().includes(String(id));
  }

  function workspaceGet() {
    try {
      const raw = localStorage.getItem(WORKSPACE_KEY);
      const obj = raw ? JSON.parse(raw) : {};
      return (obj && typeof obj === "object") ? obj : {};
    } catch { return {}; }
  }
  function workspaceSet(obj) {
    try { localStorage.setItem(WORKSPACE_KEY, JSON.stringify(obj)); } catch {}
  }
  function wsItem(id) {
    const ws = workspaceGet();
    return ws[String(id)] || {};
  }
  function wsSetItem(id, patch) {
    const ws = workspaceGet();
    const key = String(id);
    const prev = ws[key] || {};
    ws[key] = { ...prev, ...patch, updatedAt: Date.now() };
    workspaceSet(ws);
  }
  function wsPinned(id) {
    return !!wsItem(id).pinned;
  }
  function wsStatus(id) {
    return (wsItem(id).status || "").toLowerCase();
  }
  function wsTags(id) {
    const t = wsItem(id).tags;
    return Array.isArray(t) ? t.map(x => String(x).toLowerCase()) : [];
  }

  function compareGet() {
    try {
      const raw = localStorage.getItem(COMPARE_KEY);
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr.map(String).slice(0,2) : [];
    } catch { return []; }
  }
  function compareSet(arr) {
    try { localStorage.setItem(COMPARE_KEY, JSON.stringify(arr.slice(0,2).map(String))); } catch {}
  }
  function toggleCompare(id) {
    const sid = String(id);
    const cur = compareGet();
    let next = cur.includes(sid) ? cur.filter(x => x !== sid) : [sid, ...cur].slice(0,2);
    compareSet(next);
    renderCompare();
    render();
  }
  function isCompared(id) {
    return compareGet().includes(String(id));
  }

  function votesGetAll() {
    try {
      const raw = localStorage.getItem(VOTE_KEY);
      const obj = raw ? JSON.parse(raw) : {};
      return (obj && typeof obj === "object") ? obj : {};
    } catch { return {}; }
  }
  function votesSetAll(obj) {
    try { localStorage.setItem(VOTE_KEY, JSON.stringify(obj || {})); } catch {}
  }
  function voteCount(id) {
    const obj = votesGetAll();
    return Number(obj[String(id)] || 0) || 0;
  }
  function upvote(id) {
    const obj = votesGetAll();
    const key = String(id);
    const next = (Number(obj[key] || 0) || 0) + 1;
    obj[key] = next;
    votesSetAll(obj);
    return next;
  }

  async function loadData(forceFresh) {
    if (!forceFresh) {
      const cached = cacheGet();
      if (cached) return cached;
    }
    const url = DATA_URL + (DATA_URL.includes("?") ? "&" : "?") + "cb=" + Date.now();
    const res = await fetch(url, { cache: "no-store", mode: "cors", credentials: "omit" });
    if (!res.ok) throw new Error("Failed to load catalog (" + res.status + ")");
    const text = await res.text();
    let json;
    try { json = JSON.parse(text); } catch { throw new Error("Catalog returned non-JSON content."); }
    if (!Array.isArray(json)) throw new Error("Catalog JSON format unexpected.");
    return json;
  }

  // --------- TOPICS (auto-generated from titles) ----------
  const STOPWORDS = new Set([
    "a","an","the","and","or","of","in","to","for","on","with","from","by","at","as",
    "is","are","was","were","be","been","being","this","that","these","those",
    "into","over","under","between","across","within","without","toward","towards",
    "case","study","report","overview","guide","handbook","paper","policy","framework",
    "edition","series","volume","part","chapter"
  ]);
  const KEEP_SHORT = new Set(["ai","ml","iot","tpm","esg","sdg","nlp"]);

  function extractTokensFromTitle(title) {
    const raw = String(title || "").toLowerCase();
    const tokens = raw
      .replace(/[_’'"]/g, " ")
      .replace(/[^a-z0-9]+/g, " ")
      .split(/\s+/)
      .map(t => t.trim())
      .filter(Boolean);

    const cleaned = [];
    for (const t of tokens) {
      if (STOPWORDS.has(t)) continue;
      if (t.length < 3 && !KEEP_SHORT.has(t)) continue;
      if (/^\d+$/.test(t)) continue;
      cleaned.push(t);
    }
    return cleaned;
  }

  function buildFacetFilters() {
    const topicCounts = new Map();
    const catCounts = new Map();
    const yearCounts = new Map();

    state.allItems.forEach(item => {
      // Topics (count once per title to avoid long titles dominating)
      const uniq = new Set(extractTokensFromTitle(item.title || ""));
      uniq.forEach(tok => topicCounts.set(tok, (topicCounts.get(tok) || 0) + 1));

      // Categories
      (item.categories || []).forEach(cat => {
        catCounts.set(cat, (catCounts.get(cat) || 0) + 1);
      });

      // Years
      const y = item.year;
      if (y) yearCounts.set(y, (yearCounts.get(y) || 0) + 1);
    });

    // Topics (Top 60)
    const topicContainer = document.getElementById("topicFilters");
    topicContainer.innerHTML = "";
    Array.from(topicCounts.entries())
      .sort((a,b) => (b[1] - a[1]) || a[0].localeCompare(b[0]))
      .slice(0, 60)
      .forEach(([tok, count]) => {
        const id = "topic-" + tok.replace(/\W+/g, "-");
        const row = document.createElement("div");
        row.className = "flex items-center gap-2";
        row.innerHTML = `
          <input type="checkbox" id="${id}" value="${escapeHtml(tok)}"
                 class="h-3 w-3 text-amber-600 border-gray-300 rounded">
          <label for="${id}" class="cursor-pointer text-gray-700 text-sm">
            ${escapeHtml(tok)} <span class="text-gray-400 text-xs">(${count})</span>
          </label>
        `;
        const checkbox = row.querySelector("input");
        checkbox.checked = state.selectedTopics.has(tok);
        checkbox.addEventListener("change", () => {
          checkbox.checked ? state.selectedTopics.add(tok) : state.selectedTopics.delete(tok);
          applyFilters();
        });
        topicContainer.appendChild(row);
      });

    // Categories
    const catContainer = document.getElementById("categoryFilters");
    catContainer.innerHTML = "";
    Array.from(catCounts.entries())
      .sort((a, b) => a[0].localeCompare(b[0]))
      .forEach(([cat, count]) => {
        const id = "cat-" + cat.replace(/\W+/g, "-").toLowerCase();
        const row = document.createElement("div");
        row.className = "flex items-center gap-2";
        row.innerHTML = `
          <input type="checkbox" id="${id}" value="${escapeHtml(cat)}"
                 class="h-3 w-3 text-amber-600 border-gray-300 rounded">
          <label for="${id}" class="cursor-pointer text-gray-700 text-sm">
            ${escapeHtml(cat)} <span class="text-gray-400 text-xs">(${count})</span>
          </label>
        `;
        const checkbox = row.querySelector("input");
        checkbox.checked = state.selectedCategories.has(cat);
        checkbox.addEventListener("change", () => {
          checkbox.checked ? state.selectedCategories.add(cat) : state.selectedCategories.delete(cat);
          applyFilters();
        });
        catContainer.appendChild(row);
      });

    // Years
    const yearContainer = document.getElementById("yearFilters");
    yearContainer.innerHTML = "";
    Array.from(yearCounts.entries())
      .sort((a, b) => b[0] - a[0])
      .forEach(([year, count]) => {
        const id = "year-" + year;
        const row = document.createElement("div");
        row.className = "flex items-center gap-2";
        row.innerHTML = `
          <input type="checkbox" id="${id}" value="${year}"
                 class="h-3 w-3 text-amber-600 border-gray-300 rounded">
          <label for="${id}" class="cursor-pointer text-gray-700 text-sm">
            ${year} <span class="text-gray-400 text-xs">(${count})</span>
          </label>
        `;
        const checkbox = row.querySelector("input");
        checkbox.checked = state.selectedYears.has(String(year));
        checkbox.addEventListener("change", () => {
          checkbox.checked ? state.selectedYears.add(String(year)) : state.selectedYears.delete(String(year));
          applyFilters();
        });
        yearContainer.appendChild(row);
      });
  }

  function applyFilters(keepPage = false) {
    const q = state.searchQuery.toLowerCase();
    const tagNeedles = state.wsTagFilter
      .split(",")
      .map(s => s.trim().toLowerCase())
      .filter(Boolean);

    const selectedTopics = Array.from(state.selectedTopics);

    state.filteredItems = state.allItems.filter(item => {
      const titleL = (item.title || "").toLowerCase();
      const summaryL = (item.summary || "").toLowerCase();

      const matchesText = !q || titleL.includes(q) || summaryL.includes(q);

      // Topics = OR match against title
      const matchesTopics =
        selectedTopics.length === 0 ||
        selectedTopics.some(tok => titleL.includes(tok));

      const matchesCat =
        state.selectedCategories.size === 0 ||
        (item.categories || []).some(c => state.selectedCategories.has(c));

      const matchesYear =
        state.selectedYears.size === 0 ||
        state.selectedYears.has(String(item.year));

      const stFilter = state.wsStatusFilter;
      const matchesStatus = (stFilter === "all") || (wsStatus(item.id) === stFilter);

      const tags = wsTags(item.id);
      const matchesTags = tagNeedles.length === 0 || tagNeedles.every(t => tags.includes(t));

      return matchesText && matchesTopics && matchesCat && matchesYear && matchesStatus && matchesTags;
    });

    function titleKey(it) { return String(it.title || "").toLowerCase(); }

    function compareByMode(a, b) {
      switch (state.sortMode) {
        case "upvoted":
          return (voteCount(b.id) - voteCount(a.id)) || ((b.modified || 0) - (a.modified || 0));
        case "name_az":
          return titleKey(a).localeCompare(titleKey(b));
        case "name_za":
          return titleKey(b).localeCompare(titleKey(a));
        case "added_oldest":
          return (a.modified || 0) - (b.modified || 0);
        case "added_newest":
        case "newest":
        default:
          return (b.modified || 0) - (a.modified || 0);
      }
    }

    state.filteredItems.sort((a,b) => {
      const ap = wsPinned(a.id) ? 1 : 0;
      const bp = wsPinned(b.id) ? 1 : 0;
      if (ap !== bp) return bp - ap;
      return compareByMode(a, b);
    });

    if (!keepPage) state.page = 1;
    render();
  }

  // --------- Rendering (UNCHANGED from your base) ----------
  function renderCard(item) {
    const thumb = item.thumbUrl || "https://via.placeholder.com/260x360?text=PDF";
    const title = escapeHtml(item.title || "Untitled");
    const summary = escapeHtml(item.summary || "");
    const year = item.year || "";
    const cats = (item.categories || [])
      .slice(0, 3)
      .map(c => `<span class="px-2 py-0.5 border rounded-full bg-gray-50">${escapeHtml(c)}</span>`)
      .join("");

    const pinned = wsPinned(item.id);
    const status = wsStatus(item.id);
    const statusLabel = status ? status.charAt(0).toUpperCase() + status.slice(1) : "Unread";

    const addLabel = isInReadingList(item.id) ? "Remove from reading list" : "Add to reading list";
    const compareLabel = isCompared(item.id) ? "Compared" : "Compare";
    const pinLabel = pinned ? "Unpin" : "Pin";

    const votes = voteCount(item.id);

    return `
      <article class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm hover:shadow transition">
        <div class="grid grid-cols-1 sm:grid-cols-[160px,1fr] gap-4">
          <div class="w-full">
            <div class="relative border border-gray-200 bg-white rounded group">
              <button type="button" data-action="modal" data-id="${escapeHtml(item.id)}" class="block w-full text-left">
                <img src="${thumb}" alt="${title}" loading="lazy" decoding="async" referrerpolicy="no-referrer"
                     onerror="this.onerror=null;this.src='https://via.placeholder.com/260x360?text=PDF';"
                     class="w-full h-auto object-cover cursor-pointer group-hover:opacity-80 transition">
              </button>

              <button type="button" data-action="upvote" data-id="${escapeHtml(item.id)}"
                class="absolute bottom-2 right-2 z-30 bg-white/95 border border-gray-200 rounded-lg px-2 py-2 shadow hover:bg-white"
                title="Upvote (saved in your browser)" aria-label="Upvote">
                <div class="flex flex-col items-center leading-none">
                  <span class="text-sm">▲</span>
                  <span class="mt-0.5 text-xs font-semibold">${votes}</span>
                </div>
              </button>

              ${summary ? `
                <div class="tooltip-summary absolute left-0 top-0 z-20 w-80 md:w-96 bg-white/95
                            text-xs text-gray-800 p-3 opacity-0 group-hover:opacity-100
                            transition-opacity duration-200 shadow-lg ring-1 ring-black/10">
                  <div class="font-semibold mb-1">Summary</div>
                  <div class="leading-snug whitespace-normal">${summary}</div>
                </div>
              ` : ""}
            </div>
          </div>

          <div class="flex flex-col">
            <div class="flex items-center gap-2 text-xs text-gray-500">
              <span>${year}</span>
              <span class="text-gray-300">•</span>
              <span>${escapeHtml(statusLabel)}</span>
              ${pinned ? `<span class="ml-auto text-amber-600 flex items-center gap-1" title="Pinned"><svg class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M14 2l-1 1v5.2l4.6 4.6-1.4 1.4L11 9.6V3l-1-1h4zM5 14l5 5v3H8v-2.2L3.4 15.4 5 14z"/></svg><span class="text-xs font-semibold">Pinned</span></span>` : ""}
            </div>

            <a href="${reportPageUrl(item.id, item.title || "") }"
               class="mt-1 text-base md:text-lg font-semibold text-amber-700 hover:underline">
              ${title}
            </a>

            <div class="mt-3 flex flex-wrap gap-2 text-xs text-gray-500">${cats}</div>

            <div class="mt-4 flex flex-wrap gap-2">
              <button data-action="reading" data-id="${escapeHtml(item.id)}"
                 class="px-3 py-1.5 text-xs border border-gray-300 rounded bg-white hover:bg-gray-50">
                ${escapeHtml(addLabel)}
              </button>

              <button data-action="compare" data-id="${escapeHtml(item.id)}"
                 class="px-3 py-1.5 text-xs border border-gray-300 rounded bg-white hover:bg-gray-50">
                ${escapeHtml(compareLabel)}
              </button>

              <button data-action="notebooklm" data-id="${escapeHtml(item.id)}"
                 class="px-3 py-1.5 text-xs border border-gray-300 rounded bg-white hover:bg-gray-50">
                NotebookLM
              </button>

              <button data-action="pin" data-id="${escapeHtml(item.id)}"
                 class="px-3 py-1.5 text-xs border border-gray-300 rounded bg-white hover:bg-gray-50">
                <span class="inline-flex items-center gap-1"><svg class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M14 2l-1 1v5.2l4.6 4.6-1.4 1.4L11 9.6V3l-1-1h4zM5 14l5 5v3H8v-2.2L3.4 15.4 5 14z"/></svg><span>${escapeHtml(pinLabel)}</span></span>
              </button>

              <a href="${viewPageUrl(item.id, item.title || "")}" target="_blank" rel="noopener"
                 class="px-3 py-1.5 text-xs font-semibold bg-amber-600 text-white rounded hover:bg-amber-700">
                View
              </a>
            </div>
          </div>
        </div>
      </article>
    `;
  }

  function render() {
    const container = document.getElementById("cardsContainer");
    const info = document.getElementById("resultsInfo");

    const total = state.filteredItems.length;
    const maxShown = state.page * state.pageSize;
    const itemsToShow = state.filteredItems.slice(0, maxShown);

    info.textContent = `${total} publication(s) found`;
    container.innerHTML = itemsToShow.map(renderCard).join("");
  }

  function openPdfModal(item) {
    const modal = document.getElementById("pdfModal");
    const frame = document.getElementById("pdfModalFrame");
    const title = document.getElementById("pdfModalTitle");
    const viewBtn = document.getElementById("pdfModalView");

    title.textContent = item.title || "Report";
    frame.src = drivePreviewUrl(item.id);
    viewBtn.href = viewPageUrl(item.id, item.title || "");

    modal.classList.remove("hidden");
    document.body.style.overflow = "hidden";
  }

  function closePdfModal() {
    const modal = document.getElementById("pdfModal");
    const frame = document.getElementById("pdfModalFrame");
    frame.src = "";
    modal.classList.add("hidden");
    document.body.style.overflow = "";
  }

  function openPdfModalById(id) {
    const item = state.allItems.find(x => String(x.id) === String(id));
    if (item) openPdfModal(item);
  }

  function renderReadingList() {
    const wrap = document.getElementById("readingListWrap");
    const empty = document.getElementById("readingListEmpty");
    const ids = readingGet();

    if (ids.length === 0) {
      empty.classList.remove("hidden");
      wrap.classList.add("hidden");
      wrap.innerHTML = "";
      return;
    }

    empty.classList.add("hidden");
    wrap.classList.remove("hidden");

    const itemsById = new Map(state.allItems.map(it => [String(it.id), it]));
    wrap.innerHTML = ids.map(id => {
      const it = itemsById.get(String(id));
      if (!it) return "";
      return `
        <div class="border border-gray-200 rounded p-2 bg-gray-50">
          <div class="text-sm font-semibold text-gray-800 truncate">${escapeHtml(it.title || "Untitled")}</div>
          <div class="mt-2 flex flex-wrap gap-2">
            <a href="${reportPageUrl(it.id, it.title || "")}" class="px-2 py-1 text-xs border rounded bg-white hover:bg-gray-50">Open</a>
            <button data-action="modal" data-id="${escapeHtml(it.id)}" class="px-2 py-1 text-xs border rounded bg-white hover:bg-gray-50">Preview</button>
            <button data-action="reading" data-id="${escapeHtml(it.id)}" class="px-2 py-1 text-xs border rounded bg-white hover:bg-gray-50">Remove</button>
          </div>
        </div>
      `;
    }).join("");
  }

  function renderCompare() {
    const wrap = document.getElementById("compareWrap");
    const openBtn = document.getElementById("openCompareBtn");
    const ids = compareGet();
    const itemsById = new Map(state.allItems.map(it => [String(it.id), it]));

    wrap.innerHTML = ids.map(id => {
      const it = itemsById.get(String(id));
      const title = it ? (it.title || "Untitled") : id;
      return `
        <div class="border border-gray-200 rounded p-2 bg-gray-50 flex items-start gap-2">
          <div class="text-sm font-semibold text-gray-800 truncate flex-1">${escapeHtml(title)}</div>
          <button class="text-xs font-semibold text-amber-700 hover:underline" data-action="compare" data-id="${escapeHtml(id)}">Remove</button>
        </div>
      `;
    }).join("");

    if (ids.length === 2) {
      openBtn.classList.remove("hidden");
      openBtn.href = `compare.html?left=${encodeURIComponent(ids[0])}&right=${encodeURIComponent(ids[1])}`;
    } else {
      openBtn.classList.add("hidden");
      openBtn.href = "#";
    }
  }

  async function openInNotebookLM(fileId) {
    const link = driveShareUrl(fileId);
    try {
      await navigator.clipboard.writeText(link);
      window.open("https://notebooklm.google.com/", "_blank", "noopener");
      showToast("Link copied. In NotebookLM: Add sources → Paste link.");
    } catch {
      window.open("https://notebooklm.google.com/", "_blank", "noopener");
      showToast("Open NotebookLM. Copy this link from the card and paste as a source.");
    }
  }

  function setupInfiniteScroll() {
    const sentinel = document.getElementById("infiniteSentinel");
    if (!("IntersectionObserver" in window)) return;

    let ticking = false;
    const obs = new IntersectionObserver(entries => {
      const e = entries[0];
      if (!e.isIntersecting) return;
      if (ticking) return;
      const total = state.filteredItems.length;
      const maxShown = state.page * state.pageSize;
      if (maxShown >= total) return;

      ticking = true;
      state.page += 1;
      render();
      setTimeout(() => { ticking = false; }, 200);
    }, { root: null, rootMargin: "600px 0px", threshold: 0 });

    obs.observe(sentinel);
  }

  document.addEventListener("DOMContentLoaded", async () => {
    const searchInput = document.getElementById("searchInput");
    const searchBtn = document.getElementById("searchBtn");
    const clearBtn = document.getElementById("clearFilters");
    const refreshBtn = document.getElementById("userRefreshBtn");
    const refreshStatus = document.getElementById("userRefreshStatus");
    const backToTopBtn = document.getElementById("backToTop");
    const toggleReading = document.getElementById("toggleReadingList");
    const clearReading = document.getElementById("clearReadingListBtn");

    const toggleTopics = document.getElementById("toggleTopics"); // ✅ added
    const toggleCats = document.getElementById("toggleCats");
    const toggleYears = document.getElementById("toggleYears");

    const wsStatusFilter = document.getElementById("wsStatusFilter");
    const wsTagFilter = document.getElementById("wsTagFilter");
    const exportWsBtn = document.getElementById("exportWorkspaceBtn");
    const clearCompareBtn = document.getElementById("clearCompareBtn");
    const sortSelect = document.getElementById("sortSelect");
    const newsletterBtn = document.getElementById("newsletterBtn");

    document.getElementById("pdfModalClose").addEventListener("click", closePdfModal);
    document.getElementById("pdfModalBackdrop").addEventListener("click", closePdfModal);
    document.addEventListener("keydown", (e) => { if (e.key === "Escape") closePdfModal(); });

    // Toggle filters (collapsed on load)
    toggleTopics.addEventListener("click", () => {
      const el = document.getElementById("topicFilters");
      const open = el.classList.toggle("hidden") === false;
      toggleTopics.textContent = open ? "Hide" : "Show";
    });
    toggleCats.addEventListener("click", () => {
      const el = document.getElementById("categoryFilters");
      const open = el.classList.toggle("hidden") === false;
      toggleCats.textContent = open ? "Hide" : "Show";
    });
    toggleYears.addEventListener("click", () => {
      const el = document.getElementById("yearFilters");
      const open = el.classList.toggle("hidden") === false;
      toggleYears.textContent = open ? "Hide" : "Show";
    });

    sortSelect.addEventListener("change", () => {
      state.sortMode = sortSelect.value || "newest";
      applyFilters(true);
    });

    newsletterBtn.addEventListener("click", () => {
      if (!NEWSLETTER_URL) {
        showToast("Newsletter link not set yet.");
        return;
      }
      window.open(NEWSLETTER_URL, "_blank", "noopener");
    });

    function doSearch() {
      state.searchQuery = searchInput.value.trim();
      applyFilters();
    }
    searchBtn.addEventListener("click", doSearch);
    searchInput.addEventListener("keydown", (e) => { if (e.key === "Enter") doSearch(); });

    let searchTimeout = null;
    searchInput.addEventListener("input", () => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(doSearch, 220);
    });

    clearBtn.addEventListener("click", () => {
      state.searchQuery = "";
      searchInput.value = "";
      state.selectedTopics.clear();     // ✅ added
      state.selectedCategories.clear();
      state.selectedYears.clear();
      state.wsStatusFilter = "all";
      state.wsTagFilter = "";
      wsStatusFilter.value = "all";
      wsTagFilter.value = "";

      document.querySelectorAll("#topicFilters input[type=checkbox], #categoryFilters input[type=checkbox], #yearFilters input[type=checkbox]")
        .forEach(cb => cb.checked = false);

      applyFilters();
    });

    toggleReading.addEventListener("click", () => {
      const wrap = document.getElementById("readingListWrap");
      const isHidden = wrap.classList.contains("hidden");
      if (isHidden) {
        wrap.classList.remove("hidden");
        toggleReading.textContent = "Hide";
      } else {
        wrap.classList.add("hidden");
        toggleReading.textContent = "Show";
      }
    });
    clearReading.addEventListener("click", () => {
      readingSet([]);
      renderReadingList();
      render();
    });

    wsStatusFilter.addEventListener("change", () => {
      state.wsStatusFilter = wsStatusFilter.value;
      applyFilters();
    });
    wsTagFilter.addEventListener("input", () => {
      state.wsTagFilter = wsTagFilter.value;
      applyFilters();
    });

    // (your exportWorkspace not included in base snippet—keeping unchanged behavior)
    exportWsBtn.addEventListener("click", () => showToast("Export not wired in this base."));

    clearCompareBtn.addEventListener("click", () => {
      compareSet([]);
      renderCompare();
      render();
    });

    refreshBtn.addEventListener("click", async () => {
      refreshStatus.textContent = "Refreshing…";
      try {
        const data = await loadData(true);
        state.allItems = data;
        cacheSet(data);
        buildFacetFilters();
        applyFilters();
        renderReadingList();
        renderCompare();
        refreshStatus.textContent = "Last updated: " + formatTime(Date.now());
      } catch (e) {
        refreshStatus.textContent = e.message;
      }
    });

    window.addEventListener("scroll", () => {
      if (window.scrollY > 300) backToTopBtn.classList.remove("hidden");
      else backToTopBtn.classList.add("hidden");
    });
    backToTopBtn.addEventListener("click", () => window.scrollTo({ top: 0, behavior: "smooth" }));

    document.getElementById("cardsContainer").addEventListener("click", (e) => {
      const btn = e.target.closest("[data-action]");
      if (!btn) return;
      const action = btn.getAttribute("data-action");
      const id = btn.getAttribute("data-id");
      if (!id) return;

      if (action === "modal") openPdfModalById(id);
      if (action === "reading") toggleReadingItem(id);
      if (action === "compare") toggleCompare(id);
      if (action === "pin") {
        const pinned = wsPinned(id);
        wsSetItem(id, { pinned: !pinned });
        renderCompare();
        applyFilters();
      }
      if (action === "notebooklm") openInNotebookLM(id);
      if (action === "upvote") {
        const n = upvote(id);
        showToast("Upvoted (local): " + n);
        if (state.sortMode === "upvoted") applyFilters(true);
        else render();
      }
    });

    document.getElementById("readingListWrap").addEventListener("click", (e) => {
      const btn = e.target.closest("[data-action]");
      if (!btn) return;
      const action = btn.getAttribute("data-action");
      const id = btn.getAttribute("data-id");
      if (!id) return;
      if (action === "modal") openPdfModalById(id);
      if (action === "reading") toggleReadingItem(id);
      if (action === "compare") toggleCompare(id);
    });

    document.getElementById("compareWrap").addEventListener("click", (e) => {
      const btn = e.target.closest("[data-action='compare']");
      if (!btn) return;
      const id = btn.getAttribute("data-id");
      if (id) toggleCompare(id);
    });

    const cached = cacheGet();
    if (cached) {
      state.allItems = cached;
      buildFacetFilters();
      applyFilters();
      renderReadingList();
      renderCompare();
      document.getElementById("resultsInfo").textContent = "Showing cached results… updating";
    }

    try {
      const data = await loadData(false);
      state.allItems = data;
      cacheSet(data);
      buildFacetFilters();
      applyFilters();
      renderReadingList();
      renderCompare();
      refreshStatus.textContent = "Last updated: " + formatTime(Date.now());
    } catch (e) {
      if (!cached) {
        document.getElementById("resultsInfo").textContent = "Error loading data: " + e.message;
      }
    }

    sortSelect.value = state.sortMode;
    setupInfiniteScroll();
  });
</script>
</body>
</html>
