<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DocDock — Report</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    .brand-title { font-family: 'Playfair Display', serif; letter-spacing: 0.03em; }
    .brand-tagline { font-size: 0.7rem; letter-spacing: 0.18em; text-transform: uppercase; }
  </style>
</head>

<body class="bg-gray-50">
  <header class="bg-white border-b border-gray-200 shadow-sm sticky top-0 z-50">
    <div class="max-w-6xl mx-auto px-4 py-4">
      <div class="flex items-center gap-4">
        <a href="./index.html" class="block">
          <img src="logo.png" alt="DocDock logo"
               class="h-12 w-12 md:h-16 md:w-16 rounded-full object-cover shadow-md border border-gray-200 bg-white">
        </a>
        <div class="flex-1">
          <h1 class="brand-title text-2xl md:text-3xl font-semibold text-gray-900">DocDock</h1>
          <p class="brand-tagline text-amber-600 mt-1">REPORT</p>
        </div>

        <div class="flex gap-2">
          <a id="openDriveBtn" href="#" target="_blank" rel="noopener"
             class="px-3 py-2 text-sm border border-gray-300 rounded bg-white hover:bg-gray-50">
            Open in Drive
          </a>
          <a id="downloadBtn" href="#" target="_blank" rel="noopener"
             class="px-3 py-2 text-sm bg-amber-600 text-white rounded hover:bg-amber-700">
            Download file
          </a>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">
    <div id="status" class="text-sm text-gray-600 mb-4">Loading…</div>

    <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm mb-4">
      <div class="text-xs text-gray-500" id="meta"></div>
      <div class="text-xl font-semibold text-gray-900 mt-1" id="title">—</div>
      <div class="text-sm text-gray-700 mt-3 whitespace-pre-wrap" id="summary"></div>
    </div>

    <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden">
      <iframe id="viewer" class="w-full" style="height: 80vh;" title="PDF viewer" loading="lazy"></iframe>
    </div>

    <div class="mt-4">
      <a href="./index.html" class="text-sm text-blue-700 hover:underline">← Back to library</a>
    </div>
  </main>

<script>
  const DATA_URL = "https://script.google.com/macros/s/AKfycbwF2IqDTG0F5acy4K1mtBRMZg1AOp3RMHzYwHEtZcZmRV8Jbpb2_ETe4Mpnkgp-lxmy/exec";
  const CACHE_KEY = "docdock_catalog_cache_v3";

  function qs(name) {
    return new URLSearchParams(location.search).get(name);
  }

  function drivePreviewUrl(fileId) {
    return `https://drive.google.com/file/d/${encodeURIComponent(fileId)}/preview`;
  }
  function driveViewUrl(fileId) {
    return `https://drive.google.com/file/d/${encodeURIComponent(fileId)}/view`;
  }
  function driveDownloadUrl(fileId) {
    return `https://drive.google.com/uc?export=download&id=${encodeURIComponent(fileId)}`;
  }

  function cacheGet() {
    try {
      const raw = localStorage.getItem(CACHE_KEY);
      if (!raw) return null;
      const parsed = JSON.parse(raw);
      return parsed?.data || null;
    } catch(e) { return null; }
  }

  async function loadCatalog() {
    const res = await fetch(DATA_URL + (DATA_URL.includes("?") ? "&" : "?") + "cb=" + Date.now(), { cache: "no-store" });
    if (!res.ok) throw new Error("Failed to load catalog");
    return await res.json();
  }

  function render(item) {
    document.getElementById("title").textContent = item.title || "(Untitled)";
    document.getElementById("summary").textContent = item.summary || "";
    document.getElementById("meta").textContent =
      [item.year ? `Year: ${item.year}` : "", (item.categories||[]).length ? `Categories: ${(item.categories||[]).join(", ")}` : ""]
      .filter(Boolean).join(" • ");

    document.getElementById("viewer").src = drivePreviewUrl(item.id);
    document.getElementById("openDriveBtn").href = driveViewUrl(item.id);
    document.getElementById("downloadBtn").href = driveDownloadUrl(item.id);

    document.getElementById("status").textContent = "";
    document.title = `DocDock — ${item.title || "Report"}`;
  }

  (async () => {
    const id = qs("id");
    const status = document.getElementById("status");

    if (!id) {
      status.textContent = "Error: missing report id.";
      return;
    }

    // Try cache first for speed
    const cached = cacheGet();
    if (cached) {
      const item = cached.find(x => String(x.id) === String(id));
      if (item) {
        status.textContent = "Loaded from cache.";
        render(item);
        return; // fast path
      }
    }

    // Fallback: fetch full catalog
    try {
      status.textContent = "Fetching catalog…";
      const list = await loadCatalog();
      const item = list.find(x => String(x.id) === String(id));
      if (!item) throw new Error("Report not found.");
      render(item);
    } catch (e) {
      status.textContent = "Error: " + e.message;
    }
  })();
</script>
</body>
</html>
